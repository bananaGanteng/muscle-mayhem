-- Zona Perlindungan Toggle-able Version
if getgenv().ProtectionEnabled == nil then
	getgenv().ProtectionEnabled = false
end

local Players = game:GetService("Players")
local StarterGui = game:GetService("StarterGui")
local player = Players.LocalPlayer
local plots = workspace:WaitForChild("Plots")
local zone = nil

-- Fungsi pencarian base (Name/DisplayName)
local function getStructureBaseHome()
	local userLower = string.lower(player.Name)
	local displayLower = string.lower(player.DisplayName)

	for _, base in ipairs(plots:GetChildren()) do
		if base:IsA("Model") then
			local matchThisBase = false
			for _, descendant in ipairs(base:GetDescendants()) do
				if descendant:IsA("TextLabel") then
					local txt = string.lower(descendant.Text)
					if string.find(txt, userLower, 1, true) or string.find(txt, displayLower, 1, true) then
						matchThisBase = true
						break
					end
				end
			end
			if matchThisBase then
				local decorations = base:FindFirstChild("Decorations")
				if decorations then
					local innerModel = decorations:FindFirstChild("Model")
					if innerModel then
						local children = innerModel:GetChildren()
						if #children >= 5 and children[5]:IsA("BasePart") then
							return children[5]
						end
						for _, c in ipairs(children) do
							if c:IsA("BasePart") then
								return c
							end
						end
					end
				end
			end
		end
	end
	return nil
end

-- Fungsi cek posisi dalam zone
local function isInsidePart(part, position)
	local localPos = part.CFrame:PointToObjectSpace(position)
	local halfSize = part.Size / 2
	return math.abs(localPos.X) <= halfSize.X
		and math.abs(localPos.Y) <= halfSize.Y
		and math.abs(localPos.Z) <= halfSize.Z
end

-- Aktifkan perlindungan
getgenv().activateProtection = function()
	if getgenv().ProtectionEnabled then return end
	getgenv().ProtectionEnabled = true
	getgenv().ProtectionThread = true

	StarterGui:SetCore("SendNotification", {
		Title = "Anti Steal Active",
		Text = "You will exit the game if a player going to your base⚠️.",
		Duration = 10
	})

	local basePart = getStructureBaseHome()
	if basePart then
		zone = Instance.new("Part")
		zone.Name = "ExitZone"
		zone.Anchored = true
		zone.CanCollide = false
		zone.Transparency = 0.5
		zone.BrickColor = BrickColor.new("Really red")
		zone.Size = Vector3.new(37, 42, 70)
		zone.CFrame = basePart.CFrame
		zone.Parent = workspace

		task.spawn(function()
			while getgenv().ProtectionEnabled and getgenv().ProtectionThread do
				for _, plr in ipairs(Players:GetPlayers()) do
					if plr ~= player and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
						local pos = plr.Character.HumanoidRootPart.Position
						if isInsidePart(zone, pos) then
							getgenv().ProtectionThread = false
							game:Shutdown()
							break
						end
					end
				end
				task.wait(0.1)
			end
		end)
	else
		warn("❌ Gagal menemukan base kamu (Name/DisplayName tidak ditemukan di TextLabel).")
	end
end

-- Matikan perlindungan
getgenv().deactivateProtection = function()
	getgenv().ProtectionEnabled = false
	getgenv().ProtectionThread = false
	if zone and zone.Parent then
		zone:Destroy()
	end
end

-- Fungsi global untuk toggle luar
function AutoLockBase_SetEnabled(state)
	if state then
		getgenv().activateProtection()
	else
		getgenv().deactivateProtection()
	end
end
